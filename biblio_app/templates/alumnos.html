<!DOCTYPE html>
{% extends "index.html" %}
{% load static %}

{% block main_content %}
<div class="container-flex text-center justify-content-center allign-items-center" style="padding-top: 20px;">
    <div class="row justify-content-center align-middle" style="margin-top: 10px; height:60px;">
    <div class="col-md-4 text-center">
        <h4 style="margin-top: 15px;"> Registra un nuevo alumno</h4>
    </div>
    <div class="col-md-8">
        <h4>Buscar Alumnos</h4>
    </div>
    </div>
</div>
<div class="row">
    <div class="col-md-4">
        <h6>Para agregar a un alumno de Pf o preprimaria ingresa su año como 0</h6>
        <div class="container" style="overflow-y: auto; height: 600px;">
            <form class="d-flex" action="/alumno/agregar" method="post">
                {%csrf_token%}
                <table class="table">
                    <tr>
                        <td style="text-align:left; vertical-align:middle; padding-left:15px;">Nombre : </td>
                        <td><input type="text" class="form-control" name="nombre"></td>
                    </tr>
                    <tr>
                        <td style="text-align:left; vertical-align:middle; padding-left:15px;">Apellido : </td>
                        <td><input type="text" class="form-control" name="apellido"></td>
                    </tr>
                    <tr>
                        <td style="text-align:left; vertical-align:middle; padding-left:15px;">Año : </td>
                        <td><input type="text" class="form-control" name="grupo"></td>
                    </tr>
                    {% if user.is_authenticated %}
                    <tr>
                        <td colspan="2" style="align-items: center; align-self: center;"><button class="btn btn-primary" type="submit" style="align-self: center;"> Agregar alumno</button></td>
                    </tr>
                    {%endif%}
                </table>
            </form>
            {% if user.is_authenticated %}
            <form class="d-flex" action="/alumno/cargar_excel" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" name="excel_file">
                <button class="btn btn-primary" type="submit" style="align-self: center;"> Cargar desde Excel</button>
            </form>            
            <button class="btn btn-danger" type="button" onclick="confirmarBorrarAlumnos()"> Fin de curso</button>
            {% endif %}
        </div>
    </div>
    <div class="col-md-8">
        <div class="row">
           <nav class="navbar bg-body-light">
            <div class="container-fluid justify-content-center align-items-center">
                <form class="d-flex" role="search" action="alumno" method="get">
                    <input class="form-control me-2" type="search" placeholder="Buscar" aria-label="Search" name="q" value="{{ request.GET.q }}">
                    <button class="btn btn-outline-success" type="submit">Buscar</button>
                </form>
            </div>
            </nav>
            <h6> Para mostrar todos los alumnos de preprimaria solo busca "0"</h6>
            <h6> Para mostrar todos los alumnos despues de una busqueda realiza una busqueda sin contenido o apreta el boton de alumnos otra vez</h6>
            <div class="row" style="margin-top: 20 px;">
                <p>{{alumnos|length}} alumnos registrados</p>
            </div>
            <div class="row" style="margin-top: 20px;">
                <div class="container" style="overflow-y: auto; max-width: fit-content;">
                    <table class="table table-hover">
                        <!-- Agrega estas líneas en el encabezado de la tabla -->
<thead>
    <td>Clave</td>
    <td>Nombre</td>
    <td>Apellido</td>
    <td>Año</td>
    <td>Acciones</td> <!-- Nueva columna para botones -->
</thead>

<tbody>
    {% for alumno in alumnos %}
        <tr>
            <td>{{ alumno.clave|stringformat:"05d" }}</td>
            <td>{{ alumno.nombre }}</td>
            <td>{{ alumno.apellido }}</td>
            <td>
                {% if alumno.grupo == 0 %}
                    PF
                {% else %}
                    {{ alumno.grupo }}
                {% endif %}
            </td>
            <td>
                {% if user.is_authenticated %}
                <a href="{% url 'editar_alumno' pk=alumno.clave %}" class="btn btn-warning">
                    <i class="bi bi-pencil"></i> editar<!-- Ícono de lápiz -->
                </a>
                <button class="btn btn-danger" onclick="borrarAlumno('{{ alumno.clave }}')">
                    <i class="bi bi-trash"></i> eliminar<!-- Ícono de papelera -->
                </button>
                {% endif %}
            </td>
        </tr>
    {% endfor %}
</tbody>

                    </table>
                </div>
                
            </div>
        </div>
    </div>
</div>
<script>
    function confirmarBorrarAlumnos() {
        if (confirm("¿Estás seguro de que quieres realizar el proceso de fin de año este aumentara el año de todos los estudiantes y borrara a todos los estudiante que se encuentren en 6to en este momento?")) {
            // Si el usuario confirma, redirige al servidor para borrar los datos
            window.location.href = "/alumno/borrar_todos";
        } else {
            // Si el usuario cancela, no hagas nada
            // Puedes agregar un mensaje o realizar alguna acción adicional si lo deseas
        }
    }
</script>
<script>
    function borrarAlumno(pk) {
        if (confirm("¿Estás seguro de que quieres borrar a este alumno esta accion es permanente y no se puede deshacer? ")) {
            // Petición AJAX para eliminar el registro
            $.ajax({
                type: 'POST',
                url: '/alumno/eliminar/' + pk +'/',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },
                success: function () {
                    // Recargar la página o actualizar la tabla después de borrar
                    location.reload();
                },
                error: function () {
                    // Manejar errores si es necesario
                    location.reload();
                }
            });
        } else {
            // Si el usuario cancela, no hagas nada
        }
    }
</script>
<script>
    $(document).ready( function () {
        $('.table').DataTable({
            "paging": true,
            "pageLength": 20 // Mostrar solo 30 elementos por página
        });
    });
</script>

{% endblock %}
